<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Village Explorer - Abundance Token</title>
    <link rel="stylesheet" href="style.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <style>
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            background: rgba(0, 0, 0, 0.2);
            font-weight: 600;
            color: var(--text-muted);
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .hash {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent);
            cursor: pointer;
        }

        .badge-type {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .type-MINT {
            background: rgba(16, 185, 129, 0.2);
            color: #10B981;
        }

        .type-TX {
            background: rgba(139, 92, 246, 0.2);
            color: #8B5CF6;
        }

        .type-QUEST {
            background: rgba(245, 158, 11, 0.2);
            color: #F59E0B;
        }

        .type-GENESIS {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .type-WIKI {
            background: rgba(239, 68, 68, 0.2);
            color: #EF4444;
        }

        /* Viz Layout */
        .viz-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .viz-grid {
                grid-template-columns: 1fr;
            }
        }

        #dag-network {
            width: 100%;
            height: 300px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
        }

        #village-map {
            width: 100%;
            height: 300px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1;
            /* Fix overlay issue */
        }
    </style>
    <!-- Viz Libraries -->
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>

<body>
    <div class="background-glow"></div>

    <div class="app-container" style="max-width: 1200px;">
        <!-- Header -->
        <header class="glass-panel" style="display:flex; justify-content:space-between; align-items:center;">
            <div class="logo">
                <h1>Village<span class="highlight">Explorer</span></h1>
            </div>
            <div>
                <a href="index.html" class="btn btn-secondary"
                    style="text-decoration:none; font-size:0.9rem; padding: 8px 16px; border-radius: 8px;">‚Üê Back to
                    App</a>
            </div>
        </header>

        <!-- Visualizations -->
        <div class="viz-grid">
            <!-- 1. Real-Time DAG -->
            <div class="glass-panel" style="padding:15px; display:flex; flex-direction:column;">
                <h3>üï∏Ô∏è Live DAG</h3>
                <div id="dag-network"></div>
            </div>

            <!-- 2. Village Map -->
            <div class="glass-panel" style="padding:15px; display:flex; flex-direction:column;">
                <h3>üó∫Ô∏è Node Map</h3>
                <div id="village-map"></div>
            </div>
        </div>

        <!-- Stats -->
        <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:15px; margin-bottom: 20px;">
            <div class="glass-panel" style="padding:15px; text-align:center;">
                <div style="color:var(--text-muted); font-size:0.8rem;">Total Blocks</div>
                <div id="stat-blocks" style="font-size:1.5rem; font-weight:700;">-</div>
            </div>
            <div class="glass-panel" style="padding:15px; text-align:center;">
                <div style="color:var(--text-muted); font-size:0.8rem;">Network Time</div>
                <div id="stat-time" style="font-size:1.5rem; font-weight:700;">-</div>
            </div>
            <div class="glass-panel" style="padding:15px; text-align:center;">
                <div style="color:var(--text-muted); font-size:0.8rem;">Latest Hash</div>
                <div id="stat-hash"
                    style="font-size:0.8rem; font-family:'JetBrains Mono'; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                    -</div>
            </div>
        </div>

        <!-- Ledger Table -->
        <section class="glass-panel" style="padding:0;">
            <div style="padding:15px; border-bottom:1px solid rgba(255,255,255,0.1);">
                <h3>Living Ledger</h3>
            </div>
            <div class="table-container">
                <table id="ledger-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Hash / ID</th>
                            <th>Sender / Task</th>
                            <th>Amount / Hours</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="ledger-body">
                        <!-- Dynamic Content -->
                        <tr>
                            <td colspan="5" style="text-align:center; padding:30px;">Loading Village Data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <!-- Details Modal -->
    <div id="modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); align-items:center; justify-content:center; padding:20px; z-index: 9999;">
        <div class="glass-panel" style="width:100%; max-width:500px; position:relative;">
            <button onclick="document.getElementById('modal').style.display='none'"
                style="position:absolute; top:15px; right:15px; background:none; border:none; color:white; cursor:pointer; font-size: 1.2rem;">‚úï</button>
            <h3 style="margin-top:0;">Block Details</h3>
            <pre id="modal-content"
                style="background:rgba(0,0,0,0.3); padding:15px; border-radius:8px; overflow-x:auto; font-family:'JetBrains Mono'; font-size:0.8rem; color:#a5b4fc; max-height: 400px;"></pre>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let apiBase = '';
            if (window.location.protocol === 'file:') {
                apiBase = 'http://localhost:3000';
            }

            // --- MAP INIT ---
            const initMap = () => {
                const coords = [39.914, -94.525]; // OSE HQ
                const map = L.map('village-map').setView(coords, 10);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
                    subdomains: 'abcd',
                    maxZoom: 19
                }).addTo(map);

                // Nodes
                L.marker(coords).addTo(map).bindPopup('<b>Factor e Farm (OSE HQ)</b>').openPopup();
                const nodes = [
                    { lat: 39.75, lng: -94.60, name: "St. Jo Logistics Hub" },
                    { lat: 39.10, lng: -94.58, name: "KC Innovation Lab" },
                    { lat: 40.00, lng: -94.40, name: "Wind Sentinel (North)" },
                    { lat: 39.85, lng: -94.65, name: "Solar Array (West)" }
                ];
                nodes.forEach(n => {
                    L.circleMarker([n.lat, n.lng], { color: '#10B981', fillColor: '#10B981', fillOpacity: 0.5, radius: 6 })
                        .addTo(map).bindPopup(`<b>${n.name}</b>`);
                });

                // Fix Gray Box
                setTimeout(() => map.invalidateSize(), 500);
            };
            initMap();

            // --- DATA FETCH ---
            fetch(apiBase + '/api/graph')
                .then(res => res.json())
                .then(data => {
                    const blocks = Array.isArray(data) ? data.reverse() : (data.nodes || []).reverse();

                    // Stats
                    document.getElementById('stat-blocks').textContent = blocks.length;
                    document.getElementById('stat-time').textContent = new Date().toLocaleTimeString();
                    document.getElementById('stat-hash').textContent = blocks[0]?.hash || '-';

                    // Table
                    const tbody = document.getElementById('ledger-body');
                    tbody.innerHTML = '';
                    blocks.forEach(block => {
                        const tr = document.createElement('tr');
                        const data = block.data || {};
                        const type = data.block_type || 'UNKNOWN';
                        let sender = data.sender || data.task || '-';
                        let amount = data.amount ? data.amount + ' AT' : (data.hours ? data.hours + ' hrs' : '-');
                        let status = data.verified ? '‚úÖ Verified' : '‚è≥ Pending';

                        tr.innerHTML = `
                            <td><span class="badge-type type-${type}">${type}</span></td>
                            <td class="hash" title="${block.hash}">${block.hash.substring(0, 8)}...</td>
                            <td>${sender}</td>
                            <td>${amount}</td>
                            <td>${status}</td>
                        `;
                        tr.onclick = () => showDetails(block);
                        tbody.appendChild(tr);
                    });

                    // --- DAG VISUALIZATION (Vis.js) ---
                    const nodes = new vis.DataSet(blocks.map((b, i) => ({
                        id: b.hash,
                        label: (b.data.block_type || 'BLK').substring(0, 4),
                        title: b.hash,
                        color: getColor(b.data.block_type),
                        size: 20
                    })));

                    // Edges (Parents)
                    const edges = new vis.DataSet();
                    blocks.forEach(b => {
                        if (b.parents && b.parents.length > 0) {
                            b.parents.forEach(p => {
                                // Only add edge if parent exists in our view
                                if (blocks.find(blk => blk.hash === p)) {
                                    edges.add({ from: b.hash, to: p });
                                }
                            });
                        }
                    });

                    const container = document.getElementById('dag-network');
                    const netData = { nodes: nodes, edges: edges };
                    const options = {
                        nodes: {
                            shape: 'dot',
                            font: { color: '#ffffff' },
                            borderWidth: 2
                        },
                        edges: {
                            color: 'rgba(255,255,255,0.2)',
                            smooth: { type: 'continuous' }
                        },
                        physics: {
                            stabilization: false,
                            barnesHut: {
                                gravitationalConstant: -2000, // Wiggle factor
                                springConstant: 0.04,
                                springLength: 95
                            }
                        },
                        interaction: { hover: true }
                    };
                    const network = new vis.Network(container, netData, options);

                    // Click to show details in viz too
                    network.on("click", function (params) {
                        if (params.nodes.length > 0) {
                            const nodeId = params.nodes[0];
                            const block = blocks.find(b => b.hash === nodeId);
                            if (block) showDetails(block);
                        }
                    });

                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('ledger-body').innerHTML = `<tr><td colspan="5" style="text-align:center; color:#ef4444;">Connection Failed. Is the Node running on port 3000?</td></tr>`;
                });
        });

        function getColor(type) {
            switch (type) {
                case 'MINT': return '#10B981';
                case 'TX': return '#8B5CF6';
                case 'QUEST': return '#F59E0B';
                case 'WIKI': return '#EF4444';
                default: return '#64748B';
            }
        }

        function showDetails(block) {
            document.getElementById('modal-content').textContent = JSON.stringify(block, null, 2);
            document.getElementById('modal').style.display = 'flex';
        }
    </script>
</body>

</html>