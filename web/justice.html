<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Justice Hub | Ark OS</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=VT323&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        .justice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--pip-green);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .tab-content {
            display: none;
            height: calc(100% - 130px);
            overflow-y: auto;
        }

        .tab-content.active {
            display: block;
        }

        .justice-nav {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--pip-dim);
        }

        .justice-tab {
            padding: 10px 15px;
            cursor: pointer;
            color: var(--pip-dim);
            text-transform: uppercase;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .justice-tab.active {
            color: var(--pip-green);
            border-bottom: 2px solid var(--pip-green);
            text-shadow: 0 0 8px var(--pip-glow);
        }

        .log-entry {
            border-left: 2px solid var(--pip-dim);
            padding-left: 10px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .log-type {
            font-weight: bold;
            color: var(--pip-warning);
        }

        .queue-item {
            background: rgba(16, 249, 111, 0.05);
            border: 1px solid var(--pip-dim);
            padding: 15px;
            margin-bottom: 10px;
        }

        .queue-meta {
            font-size: 0.8rem;
            color: var(--pip-dim);
            margin-bottom: 5px;
        }
    </style>
</head>

<body>
    <div class="pip-boy-chassis">
        <div class="crt-screen">
            <div class="crt-overlay"></div>
            <div class="screen-content">
                <header class="justice-header">
                    <h1 style="border:none; margin:0;">Justice <span class="highlight">Hub</span></h1>
                    <div id="user-status" style="font-size:0.8rem;">[PROTOCOL: SOVEREIGN_COURT]</div>
                </header>

                <nav class="justice-nav">
                    <div id="tab-inbox" class="justice-tab active" onclick="showTab('oracle-inbox')">Oracle Inbox</div>
                    <div id="tab-report" class="justice-tab" onclick="showTab('report-center')">Report Center</div>
                    <div id="tab-log" class="justice-tab" onclick="showTab('transparency-log')">Transparency</div>
                    <div id="tab-appeals" class="justice-tab" onclick="showTab('appeals-court')">Appeals</div>
                </nav>

                <!-- Oracle Inbox -->
                <div id="oracle-inbox" class="tab-content active">
                    <h3>Pending Verifications</h3>
                    <div id="verification-queue">
                        <div class="queue-item">Scanning neural mesh for pending blocks...</div>
                    </div>
                    <h3 style="margin-top:30px;">Moderation Queue</h3>
                    <div id="moderation-queue">
                        <div class="queue-item">No active safety violations detected.</div>
                    </div>
                </div>

                <!-- Report Center -->
                <div id="report-center" class="tab-content">
                    <h3>Submit Safety Report</h3>
                    <div class="pip-box">
                        <p style="font-size:0.8rem; margin-bottom:15px; color:var(--pip-warning);">⚠️ Reporting deposit:
                            0.10 AT (Refunded if valid)</p>
                        <input type="text" id="report-content-id" placeholder="Content Hash or User ID">
                        <select id="report-category">
                            <option value="violence">Violence / Harm</option>
                            <option value="fraud">Fraud / Scam</option>
                            <option value="spam">Spam / Noise</option>
                            <option value="other">Other</option>
                        </select>
                        <textarea id="report-reason" placeholder="Explain the violation..." rows="4"></textarea>
                        <button class="btn-pip" onclick="submitReport()" style="margin-top:10px; width:100%;">Submit to
                            Oracles</button>
                    </div>
                </div>

                <!-- Transparency Log -->
                <div id="transparency-log" class="tab-content">
                    <h3>Public Governance Audit</h3>
                    <div id="log-list" style="margin-bottom:20px;">
                        <!-- Entries load here -->
                    </div>
                    <button class="btn-pip" onclick="loadLogs()" style="width:100%;">Refresh Logs</button>
                </div>

                <!-- Appeals Court -->
                <div id="appeals-court" class="tab-content">
                    <h3>Sovereign Appeal Court</h3>
                    <div class="pip-box">
                        <p style="opacity:0.6;">Formal appeals for resolution over-ruled by Oracles.</p>
                        <p style="font-size:0.8rem; color:var(--pip-dim);">[STATUS: SYSTEM_GENESIS_CORE]</p>
                    </div>
                </div>
            </div>
        </div>

        <nav class="pip-nav-container">
            <button class="pip-tab" onclick="window.location.href='index.html'">Main</button>
            <button class="pip-tab active">Justice</button>
            <button class="pip-tab" onclick="window.location.href='wallet.html'">Wallet</button>
        </nav>
    </div>

    <script src="app.js"></script>
    <script>
        // Justice Hub Logic
        function showTab(tabId) {
            // Hide all
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.justice-tab').forEach(t => t.classList.remove('active'));

            // Show target
            document.getElementById(tabId).classList.add('active');

            // Active tab styling
            const map = {
                'oracle-inbox': 'tab-inbox',
                'report-center': 'tab-report',
                'transparency-log': 'tab-log',
                'appeals-court': 'tab-appeals'
            };
            document.getElementById(map[tabId]).classList.add('active');

            if (tabId === 'transparency-log') loadLogs();
            if (tabId === 'oracle-inbox') loadQueues();
        }

        async function loadLogs() {
            const list = document.getElementById('log-list');
            list.innerHTML = '<div class="blink">SYNCHRONIZING WITH LEDGER...</div>';
            try {
                const data = await window.apiFetch('/api/moderation/log');
                const logs = data.logs || [];
                if (logs.length === 0) {
                    list.innerHTML = '<div style="opacity:0.5;">No governance events recorded.</div>';
                    return;
                }
                list.innerHTML = logs.map(log => `
                    <div class="log-entry">
                        <div class="log-meta">[${new Date(log.timestamp * 1000).toLocaleTimeString()}] ID: ${log.id}</div>
                        <div class="log-type">${log.type}</div>
                        <div style="opacity:0.8; font-family:'VT323'; font-size:1.1rem;">DATA: ${JSON.stringify(log.data)}</div>
                    </div>
                `).join('');
            } catch (e) {
                list.innerHTML = '<div style="color:var(--pip-alert);">⚠️ SYNC ERROR: ' + e.message + '</div>';
            }
        }

        async function loadQueues() {
            const vQueue = document.getElementById('verification-queue');
            const mQueue = document.getElementById('moderation-queue');

            // 1. Load Verification Queue (Triple Verification)
            try {
                const vTasks = await window.apiFetch('/api/verification/pending');
                vQueue.innerHTML = vTasks && vTasks.length ? vTasks.map(task => `
                    <div class="queue-item">
                        <div class="queue-meta">QUEST: ${task.quest_id} | DOER: ${task.doer}</div>
                        <div>EXPIRES IN: ${Math.round(task.expires_in / 60)}m</div>
                        <div style="margin-top:10px; display:flex; gap:10px;">
                            <button class="btn-pip" style="flex:1;" onclick="verify('${task.verification_id}', true)">APPROVE</button>
                            <button class="btn-pip" style="flex:1; border-color:var(--pip-alert); color:var(--pip-alert);" onclick="verify('${task.verification_id}', false)">REJECT</button>
                        </div>
                    </div>
                `).join('') : '<div style="opacity:0.5;">INBOX EMPTY. NEURAL MESH IS CLEAN.</div>';
            } catch (e) { vQueue.innerHTML = 'ERROR LOADING VERIFICATION QUEUE.'; }

            // 2. Load Moderation Queue (Reports)
            try {
                const data = await window.apiFetch('/api/moderation/queue');
                const reports = data.queue || [];
                mQueue.innerHTML = reports.length ? reports.map(task => `
                    <div class="queue-item">
                        <div class="queue-meta">REPORT ID: ${task.report_id} | CATEGORY: ${task.category}</div>
                        <div style="margin-bottom:10px;">REASON: ${task.reason}</div>
                        <div style="display:flex; gap:10px;">
                            <button class="btn-pip" style="flex:1;" onclick="resolveReport('${task.report_id}', 'ALLOW')">ALLOW</button>
                            <button class="btn-pip" style="flex:1; border-color:var(--pip-alert); color:var(--pip-alert);" onclick="resolveReport('${task.report_id}', 'BLOCK')">BLOCK</button>
                        </div>
                    </div>
                `).join('') : '<div style="opacity:0.5;">NO OUTSTANDING SAFETY REPORTS.</div>';
            } catch (e) { mQueue.innerHTML = 'ERROR LOADING MODERATION QUEUE.'; }
        }

        async function verify(id, approved) {
            try {
                await window.apiFetch('/api/verification/submit', {
                    method: 'POST',
                    body: { request_id: id, decision: approved ? 'approve' : 'reject' }
                });
                alert('VERIFICATION SUBMITTED.');
                loadQueues();
            } catch (e) { alert('ERROR: ' + e.message); }
        }

        async function resolveReport(id, resolution) {
            // Resolution logic would go to a specialized endpoint
            alert('REPORT RESOLUTION: ' + resolution + ' (NOT YET LINKED TO LEDGER)');
        }

        async function submitReport() {
            const content_id = document.getElementById('report-content-id').value;
            const reason = document.getElementById('report-reason').value;
            const category = document.getElementById('report-category').value;

            if (!content_id || !reason) return alert('CONTENT ID AND REASON REQUIRED.');

            try {
                await window.apiFetch('/api/moderation/report', {
                    method: 'POST',
                    body: { content_id, reason, category }
                });
                alert('REPORT FILED. 0.10 AT STAKED.');
                document.getElementById('report-content-id').value = '';
                document.getElementById('report-reason').value = '';
            } catch (e) { alert('ERROR: ' + e.message); }
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            // Check if app.js main was called, if not, we might need to manually trigger some bits
            // but apiFetch is global so we are good.
        });
    </script>
</body>

</html>